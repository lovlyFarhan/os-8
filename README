
# bash -e README

mkdir -p documentation
#doxygen os.dox
COMPILER=clang++	# 46.041s, in compile terms alone, clang++ is about 20% faster than g++
#COMPILER=g++		# 49.597s
#COMPILER=llvm-g++	# 50.588s

if [ "$COMPILER" = "clang++" ]; then
  NONTEMPLATEFRIENDWARNING=
else
  NONTEMPLATEFRIENDWARNING=-Wno-non-template-friend
fi

GCC_WARNINGS="-Wall -Weffc++ -Wextra -Wshadow -Wwrite-strings"
LIBRARIES="-lsqlite3 -framework Carbon"

TESTS="\
	ReferencedString:251:0.028s:0.001s:0.003s\
	Hash:47:0.004s:0.001s:0.002s\
	EnumSet:189:0.007s:0.001s:0.002s\
	Library:93(113ppc):0.248s:0.052s:0.051s\
	Exception:19:0.013s:0.001s:0.002s\
	Thread:27:0.058s:0.001s:0.004s\
	File:35:0.005s:0.001s:0.002s\
	Sqlite3Plus:31:0.324s:0.002s:0.008s\
	Mutex:15:0.033s:0.011s:0.006s\
	AtomicInteger:12:0.421s:0.034s:0.079s\
	DateTime:13(12ppc):0.007s:0.001s:0.002s\
	RWLock:18:7.427s:0.017s:0.022s\
	SocketServer:15:7.427s:0.017s:0.022s\
	ReferenceCounted:210(225ppc):3.061s:4.185s:5.835s\
	ArchiveFile:133(135ppc):0.002s:0.001s:001s\
	Bencode:60(62ppc):0.002s:0.001s:0.001s\
	CompactNumber:15:0.005s:0.001s:0.002s\
	"

rm -f /tmp/*.archive
rm -f /tmp/*.test_log

for TEST in $TESTS
do
  BASENAME=`echo $TEST | cut -d: -f1`
  WHITECOUNT=`echo $TEST | cut -d: -f2`
  REALTIME=`echo $TEST | cut -d: -f3`
  USERTIME=`echo $TEST | cut -d: -f4`
  SYSTIME=`echo $TEST | cut -d: -f5`
  $COMPILER -o /tmp/$BASENAME tests/$BASENAME"_test".cpp -I.. $GCC_WARNINGS $LIBRARIES
  printf "$BASENAME: real < $REALTIME user < $USERTIME sys < $SYSTIME\n"
  time /tmp/$BASENAME &> /tmp/$BASENAME.test_log
  $COMPILER -o /tmp/$BASENAME tests/$BASENAME"_test".cpp -I.. -include Tracer.h $GCC_WARNINGS $LIBRARIES
  echo
  printf "expecting >= $WHITECOUNT\n"
  /tmp/$BASENAME 2>&1 | tee -a /tmp/osTests.test_log >> /tmp/$BASENAME.test_log
  cat /tmp/$BASENAME.test_log | grep -w $BASENAME\\.h | sort | uniq | wc -l
  cat /tmp/$BASENAME.test_log | grep -i fail || true
  echo
  echo ---
  echo
done

HEADERS=`ls *.h`
for HEADER in $HEADERS
do
	COUNT=`cat /tmp/osTests.test_log | grep -w $HEADER | sort | uniq | wc -l`
	echo $HEADER $COUNT
done
